<!doctype html>
<html>
<head>
  <meta charset='utf-8' />
  <title>Login</title>
  <meta name='viewport' content='width=device-width,initial-scale=1' />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 40px; }
    .card { max-width: 420px; margin: 0 auto; border:1px solid #ddd; border-radius:12px; padding:20px; }
    label { font-weight:600; display:block; margin:12px 0 6px; }
    input { width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; }
    button { margin-top:14px; width:100%; padding:10px; border-radius:10px; border:1px solid #ccc; background:#fafafa; cursor:pointer; }
    button:hover { background:#f0f0f0; }
    .err { color:#a00; margin-top:10px; min-height:20px;}
  </style>
</head>
<body>
  <div class='card'>
    <h1>Sign in</h1>
    <label for='email'>Email</label>
    <input id='email' type='email' placeholder='you@example.com' autocomplete='username' />
    <label for='pw'>Password</label>
    <input id='pw' type='password' placeholder='••••••••' autocomplete='current-password' />
    <button id='go'>Sign in</button>
    <div id='err' class='err'></div>
  </div>
  <script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations?.().then(rs => rs.forEach(r => r.unregister()));
}
</script>
  <script type='module'>
    import { initFirebase } from "/firebase-config.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

    const err = document.getElementById('err');
    const email = document.getElementById('email');
    const pw = document.getElementById('pw');
    const go = document.getElementById('go');

    const app = await initFirebase();
    const auth = getAuth(app);

    // If already signed in, jump straight to driver
    onAuthStateChanged(auth, (user) => { if (user) location.replace('/driver.html'); });

    go.addEventListener('click', async () => {
      err.textContent = '';
      try {
        const userCred = await signInWithEmailAndPassword(auth, email.value.trim(), pw.value);
        location.replace('/driver.html');
      } catch (e) {
        console.error(e);
        err.textContent = e?.message ?? String(e);
        if ((e?.code||'').includes('operation-not-allowed')) {
          err.textContent = 'Email/Password sign-in is disabled in Firebase Auth. Enable it in the console.';
        }
      }
    });
  </script>
</body>
</html>
