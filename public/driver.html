<!doctype html><html lang='en'>
<head>
  <meta charset='utf-8'/><meta name='viewport' content='width=device-width,initial-scale=1'/>
  <title>Driver · ATL Driver Scheduler</title>
  <link rel='stylesheet' href='/styles/tokens.css?v=20251104_135140'>
  <style>
    #boot{position:fixed;inset:0;background:#fff;display:flex;align-items:center;justify-content:center;font:600 16px system-ui;color:#64748b;z-index:9999}
    .day.locked{opacity:.65;filter:saturate(.7)}
    .day.locked .badge{background:#e2e8f0;color:#0f172a;border-color:#cbd5e1}
    .day.locked .num:after{content:"✓";font-size:12px;margin-left:6px;color:#16a34a;font-weight:800}
  </style>
  <link rel='stylesheet' href='/styles/overrides.css'>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.getRegistrations?.().then(rs => rs.forEach(r => r.unregister()));
    }
  </script>
</head>
<body>
<div id='boot'>Loading…</div>

<header>
  <strong>ATL Driver Scheduler</strong>
  <div>
    <span id='userEmail' class='muted'></span>
    <button id='roleActionBtn' class='btn secondary' style='margin-left:10px;'>Clear selections</button>
    <button id='logoutBtn' class='btn secondary' style='margin-left:10px;'>Log out</button>
  </div>
</header>

<div class='wrap'>
  <div class='card' style='margin-bottom:12px'>
    <div id='windowBanner' class='muted'>Loading window…</div>
  </div>

  <div style='display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap'>
    <div class='card' style='flex:1 1 720px;min-width:320px'>
      <div style='display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap'>
        <button id='prev' class='btn secondary'>&#8592; Prev</button>
        <div id='monthLabel' class='muted' style='min-width:220px;text-align:center;font-weight:700'></div>
        <button id='next' class='btn secondary'>Next &#8594;</button>
        <div style='flex:1'></div>
      </div>
      <div id='cal' class='cal'></div>
    </div>

    <div class='card' style='flex:0 0 360px'>
      <h3 style='margin:0 0 8px 0'>Selected Dates <span id='selCount' class='count-pill'>0</span></h3>
      <ul id='chosen' class='muted' style='padding-left:18px'></ul>
      <button id='submit' class='btn'>Submit</button>
      <div id='submitMsg' class='muted' style='margin-top:8px'></div>

      <div style='margin-top:12px'>
        <div style='font-weight:700;margin-bottom:6px'>Submitted (locked)</div>
        <ul id='lockedList' class='muted' style='padding-left:18px'></ul>
      </div>

      <div id='roleSlot' class='muted' style='margin-top:12px'></div>
    </div>
  </div>
</div>

<script type='module'>
  import { auth, db } from "/js/app-init.js";
  import { onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  try { await setPersistence(auth, browserLocalPersistence); } catch {}

  const emailEl=document.getElementById('userEmail');
  const roleBtn=document.getElementById('roleActionBtn');
  const logoutBtn=document.getElementById('logoutBtn');

  const cal=document.getElementById('cal');
  const monthLbl=document.getElementById('monthLabel');

  const chosen=document.getElementById('chosen');
  const lockedList=document.getElementById('lockedList');
  const selCount=document.getElementById('selCount');

  const submitBtn=document.getElementById('submit');
  const submitMsg=document.getElementById('submitMsg');
  const roleSlot=document.getElementById('roleSlot');
  const banner=document.getElementById('windowBanner');

  let view = new Date(); view.setDate(1);
  const TODAY = new Date(); TODAY.setHours(0,0,0,0);
  const DEFAULT_SLOTS = 11;

  const selected = new Set();
  const locked = new Set();

  let openAt = null, closeAt = null;

  const lc=(s)=> (s||"").toLowerCase();
  const ym=(d)=> d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");

  function keyForMonth(d){ return "slots:"+ym(d); }
  function loadMonth(d){ const raw=localStorage.getItem(keyForMonth(d)); return raw?JSON.parse(raw):{}; }
  function saveMonth(d,map){ localStorage.setItem(keyForMonth(d), JSON.stringify(map)); }

  function daysInMonth(d){ const y=d.getFullYear(),m=d.getMonth(); return new Date(y,m+1,0).getDate(); }
  function firstWeekday(d){ const t=new Date(d); t.setDate(1); return t.getDay(); }
  function isPast(y,m,day){ const dt=new Date(y,m,day); dt.setHours(0,0,0,0); return dt < TODAY; }

  function updateSelCount(){ selCount.textContent = String(selected.size); }

  function bannerText(){
    const now = new Date();
    if (!openAt || !closeAt) return "Scheduling window not set yet.";
    if (now < openAt) return "Opens at " + openAt.toLocaleString("en-US",{timeZone:"America/New_York"});
    if (now >= openAt && now <= closeAt) return "Open until " + closeAt.toLocaleString("en-US",{timeZone:"America/New_York"});
    return "Window closed — late applications allowed only for days with remaining slots.";
  }

  function renderChosen(){
    chosen.innerHTML = "";
    const arr=[...selected].sort((a,b)=>a-b);
    for(const d of arr){
      const li=document.createElement('li'); li.className='chosen-item';
      const left=document.createElement('span'); left.textContent=String(d);
      const btn=document.createElement('button'); btn.className='icon-btn'; btn.title='Remove'; btn.textContent='×';
      btn.addEventListener('click', ()=>{ selected.delete(d); render(); renderChosen(); updateSelCount(); });
      li.appendChild(left); li.appendChild(btn); chosen.appendChild(li);
    }
    updateSelCount();
  }

  function renderLocked(){
    lockedList.innerHTML = "";
    const arr=[...locked].sort((a,b)=>a-b);
    for(const d of arr){
      const li=document.createElement('li');
      li.textContent = String(d);
      lockedList.appendChild(li);
    }
  }

  function canPickDay(rem, y, m, day){
    // Don't allow re-picking a day already submitted by THIS user (month-scoped).
    if (locked.has(day)) return false;

    // Window gating: must be open, but after close allow picking only if remaining slots.
    const now = new Date();
    if (!openAt || !closeAt) return false;
    if (now < openAt) return false;
    return rem > 0;
  }

  function render(){
    banner.textContent = bannerText();

    const y=view.getFullYear(), m=view.getMonth();
    monthLbl.textContent = view.toLocaleString(undefined,{month:'long',year:'numeric'});

    const map = loadMonth(view);
    const total=daysInMonth(view), pad=firstWeekday(view);

    cal.innerHTML="";
    const weekdays=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    for(const w of weekdays){
      const h=document.createElement('div');
      h.className='muted';
      h.style.fontWeight='700';
      h.style.textAlign='center';
      h.textContent=w;
      cal.appendChild(h);
    }

    for(let i=0;i<pad;i++){
      const blank=document.createElement('div');
      blank.className='day';
      blank.style.visibility='hidden';
      cal.appendChild(blank);
    }

    for(let d=1; d<=total; d++){
      const cell=document.createElement('div'); cell.className='day';
      const num=document.createElement('div'); num.className='num'; num.textContent=String(d);

      const past = isPast(y,m,d);
      const rem  = map[d] ?? DEFAULT_SLOTS;

      const badge=document.createElement('div');
      badge.className='badge'+(rem===0?' zero':'');
      badge.textContent=String(rem);

      const disabled = past || !canPickDay(rem,y,m,d);

      if(disabled) cell.classList.add('disabled');
      if(locked.has(d)) cell.classList.add('locked');
      if(selected.has(d)) cell.style.outline='3px solid #16a34a';

      cell.addEventListener('click', ()=>{
        if(disabled) return;
        if(selected.has(d)){
          selected.delete(d);
          cell.style.outline='';
        } else {
          selected.add(d);
          cell.style.outline='3px solid #16a34a';
        }
        renderChosen();
      });

      cell.appendChild(num);
      cell.appendChild(badge);
      cal.appendChild(cell);
    }
  }

  function bindClearSelections(){
    roleBtn.textContent = "Clear selections";
    roleBtn.onclick = ()=>{ selected.clear(); renderChosen(); render(); };
  }

  async function loadWindow(){
    const s = await getDoc(doc(db,"settings","window"));
    if (!s.exists()){
      openAt=null; closeAt=null;
      return;
    }
    const d=s.data();
    openAt = d.openAt ? new Date(d.openAt) : null;
    closeAt= d.closeAt? new Date(d.closeAt): null;
  }

  async function loadLocked(uid, ymStr){
    // Loads THIS user's submitted dates for the month from picks/{uid_ym}
    locked.clear();
    const id = uid + "_" + ymStr;
    const snap = await getDoc(doc(db,"picks", id));
    const dates = (snap.exists() && Array.isArray(snap.data()?.dates)) ? snap.data().dates : [];
    for(const v of dates){
      const n = Number(v);
      if(Number.isFinite(n)) locked.add(n);
    }
    renderLocked();
  }

  function resolveRoleFromToken(tok){
    const roleStr = (tok?.claims?.role || "").toString().toLowerCase();
    const rolesArr = Array.isArray(tok?.claims?.roles) ? tok.claims.roles.map(x=>String(x).toLowerCase()) : [];
    return roleStr || (rolesArr.includes("admin") ? "admin" : (rolesArr.includes("manager") ? "manager" : (rolesArr.includes("baselead") ? "baselead" : (rolesArr.includes("supervisor") ? "supervisor" : "driver"))));
  }

  async function firstAuthUser(){
    return await new Promise((res)=>onAuthStateChanged(auth, u=>res(u), {onlyOnce:true}));
  }

  const u0 = await firstAuthUser();
  if(!u0){
    window.location.href="/login.html";
  } else {
    document.getElementById('boot')?.remove();

    const email = lc(u0.email);
    const uid = u0.uid;

    emailEl.textContent = email;

    await loadWindow();

    let role = "driver";
    try {
      const tok = await u0.getIdTokenResult(true);
      role = resolveRoleFromToken(tok);
    } catch {}

    roleSlot.textContent = "role: " + role;

    if (["admin","manager","baselead","supervisor"].includes(role)) {
      roleBtn.textContent = "Supervisor Console";
      roleBtn.onclick = ()=>{ window.location.href="/supervisor/"; };
    } else {
      bindClearSelections();
    }

    await loadLocked(uid, ym(view));

    document.getElementById('prev').onclick = async ()=>{
      view.setMonth(view.getMonth()-1);
      selected.clear();
      await loadLocked(uid, ym(view));
      render(); renderChosen(); updateSelCount();
    };

    document.getElementById('next').onclick = async ()=>{
      view.setMonth(view.getMonth()+1);
      selected.clear();
      await loadLocked(uid, ym(view));
      render(); renderChosen(); updateSelCount();
    };

    render(); renderChosen(); updateSelCount();

    submitBtn.addEventListener('click', async ()=>{
      submitMsg.textContent = "";

      const arr = [...selected].sort((a,b)=>a-b);
      if(arr.length === 0){
        submitMsg.textContent = "Pick at least one date.";
        return;
      }

      // Filter out already-locked (safety)
      const toAdd = arr.filter(d => !locked.has(d));
      if(toAdd.length === 0){
        submitMsg.textContent = "Those dates are already submitted.";
        selected.clear(); renderChosen(); render();
        return;
      }

      // Must be in an open window to submit
      const now = new Date();
      if(!openAt || !closeAt){
        submitMsg.textContent = "Scheduling window is not set.";
        return;
      }
      if(now < openAt){
        submitMsg.textContent = "Scheduling window is not open yet.";
        return;
      }

      const ymStr = ym(view);
      const id = uid + "_" + ymStr;

      try{
        const merged = [...new Set([...locked, ...toAdd])].sort((a,b)=>a-b);
        await setDoc(
          doc(db,"picks", id),
          { uid, email, ym: ymStr, dates: merged, ts: (new Date()).toISOString() },
          { merge: true }
        );

        // Update local locked set immediately
        for(const d of toAdd) locked.add(d);
        renderLocked();

        // Decrement local "remaining" display (UI only)
        const map=loadMonth(view);
        for(const d of toAdd){
          const cur=map[d] ?? DEFAULT_SLOTS;
          if(cur>0) map[d]=cur-1;
        }
        saveMonth(view,map);

        submitMsg.textContent = "Submitted ✓";

        selected.clear();
        render(); renderChosen(); updateSelCount();
      }catch(e){
        console.error(e);
        submitMsg.textContent = "Submit failed: " + (e?.message||e);
      }
    });

    onAuthStateChanged(auth, (u)=>{ if(!u){ window.location.href="/login.html"; }});
  }

  function clearLocalSchedulerCache(){
    try{
      const keys = [];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(k && k.startsWith("slots:")) keys.push(k);
      }
      for(const k of keys) localStorage.removeItem(k);
    } catch {}
  }

  logoutBtn.addEventListener('click', async ()=>{
    try{ await signOut(auth); }catch(e){}
    try{ selected.clear(); locked.clear(); } catch {}
    try{ clearLocalSchedulerCache(); sessionStorage.clear(); }catch(_){}
    window.location.href="/login.html";
  });
</script>

</body></html>