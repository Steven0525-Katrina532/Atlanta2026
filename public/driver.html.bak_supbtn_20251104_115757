<!doctype html><html lang='en'><head>
<meta charset='utf-8'/><meta name='viewport' content='width=device-width,initial-scale=1'/>
<title>Driver · ATL Driver Scheduler</title>
<link rel='stylesheet' href='/styles/tokens.css'>
</head><body>
<header>
  <strong>ATL Driver Scheduler</strong>
  <div>
    <span id='userEmail' class='muted'></span>
    <button id='supBtn' class='btn secondary' style='margin-left:10px;display:none;'>Supervisor Console</button>
    <button id='logoutBtn' class='btn secondary' style='margin-left:10px;'>Log out</button>
  </div>
</header>

<div class='wrap'>
  <div style='display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap'>
    <div class='card' style='flex:1 1 720px;min-width:320px'>
      <div style='display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap'>
        <button id='prev' class='btn secondary'>&#8592; Prev</button>
        <div id='monthLabel' class='muted' style='min-width:220px;text-align:center;font-weight:700'></div>
        <button id='next' class='btn secondary'>Next &#8594;</button>
        <div style='flex:1'></div>
        <button id='clearSel' class='btn secondary'>Clear selections</button>
      </div>
      <div id='cal' class='cal'></div>
    </div>
    <div class='card' style='flex:0 0 340px'>
      <h3 style='margin:0 0 8px 0'>Selected Dates <span id='selCount' class='count-pill'>0</span></h3>
      <ul id='chosen' class='muted' style='padding-left:18px'></ul>
      <button id='submit' class='btn'>Submit</button>
      <div id='submitMsg' class='muted' style='margin-top:8px'></div>
      <div id='roleSlot' style='margin-top:12px'></div>
    </div>
  </div>
</div>

<script type='module'>
  import { initializeApp, getApps, getApp, deleteApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  // clean init
  try { if (getApps().length) { await deleteApp(getApp()); } } catch(e) {}
  const app = initializeApp({
    apiKey: "AIzaSyA9zGySiV_LYI-Vs0acQn1jhKdst_jzCIw",
    authDomain: "atl-driver-scheduler-demo.firebaseapp.com",
    projectId: "atl-driver-scheduler-demo"
  });
  const auth = getAuth(app);
  await setPersistence(auth, browserLocalPersistence);
  const db = getFirestore(app);

  // elements
  const emailEl   = document.getElementById('userEmail');
  const logoutBtn = document.getElementById('logoutBtn');
  const supBtn    = document.getElementById('supBtn');
  const cal       = document.getElementById('cal');
  const monthLbl  = document.getElementById('monthLabel');
  const chosen    = document.getElementById('chosen');
  const selCount  = document.getElementById('selCount');
  const submitBtn = document.getElementById('submit');
  const clearSel  = document.getElementById('clearSel');
  const submitMsg = document.getElementById('submitMsg');

  // state
  let view = new Date(); view.setDate(1);
  const TODAY = new Date(); TODAY.setHours(0,0,0,0);
  const DEFAULT_SLOTS = 11;
  const selected = new Set();

  // helpers
  function keyForMonth(d){ const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,"0"); return "slots:"+y+"-"+m; }
  function loadMonth(d){ const raw=localStorage.getItem(keyForMonth(d)); return raw?JSON.parse(raw):{}; }
  function saveMonth(d,map){ localStorage.setItem(keyForMonth(d), JSON.stringify(map)); }
  function daysInMonth(d){ const y=d.getFullYear(),m=d.getMonth(); return new Date(y,m+1,0).getDate(); }
  function firstWeekday(d){ const t=new Date(d); t.setDate(1); return t.getDay(); }
  function isPast(y,m,day){ const dt=new Date(y,m,day); dt.setHours(0,0,0,0); return dt < TODAY; }
  function updateSelCount(){ selCount.textContent = String(selected.size); }

  function renderChosen(){
    chosen.innerHTML = "";
    const arr=[...selected].sort((a,b)=>a-b);
    for(const d of arr){
      const li=document.createElement('li'); li.className='chosen-item';
      const left=document.createElement('span'); left.textContent=d;
      const btn=document.createElement('button'); btn.className='icon-btn'; btn.title='Remove'; btn.textContent='×';
      btn.addEventListener('click', ()=>{ selected.delete(d); render(); renderChosen(); updateSelCount(); });
      li.appendChild(left); li.appendChild(btn); chosen.appendChild(li);
    }
    updateSelCount();
  }

  function render(){
    const y=view.getFullYear(), m=view.getMonth();
    monthLbl.textContent = view.toLocaleString(undefined,{month:'long',year:'numeric'});
    const map = loadMonth(view);
    const total=daysInMonth(view), pad=firstWeekday(view);
    cal.innerHTML="";
    const weekdays=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    for(const w of weekdays){ const h=document.createElement('div'); h.className='muted'; h.style.fontWeight='700'; h.style.textAlign='center'; h.textContent=w; cal.appendChild(h); }
    for(let i=0;i<pad;i++){ const blank=document.createElement('div'); blank.className='day'; blank.style.visibility='hidden'; cal.appendChild(blank); }
    for(let d=1; d<=total; d++){
      const cell=document.createElement('div'); cell.className='day';
      const num=document.createElement('div'); num.className='num'; num.textContent=d;
      const past = isPast(y,m,d);
      const rem  = map[d] ?? DEFAULT_SLOTS;
      const badge=document.createElement('div'); badge.className='badge'+(rem===0?' zero':''); badge.textContent=rem;

      const disabled = past || rem===0;
      if(disabled) cell.classList.add('disabled');

      if(selected.has(d)) cell.style.outline='3px solid #16a34a';
      cell.addEventListener('click', ()=>{
        if(disabled) return;
        if(selected.has(d)){ selected.delete(d); cell.style.outline=''; }
        else { selected.add(d); cell.style.outline='3px solid #16a34a'; }
        renderChosen();
      });
      cell.appendChild(num);
      cell.appendChild(badge);
      cal.appendChild(cell);
    }
  }

  document.getElementById('prev').addEventListener('click',()=>{ view.setMonth(view.getMonth()-1); selected.clear(); render(); renderChosen(); updateSelCount(); });
  document.getElementById('next').addEventListener('click',()=>{ view.setMonth(view.getMonth()+1); selected.clear(); render(); renderChosen(); updateSelCount(); });
  clearSel.addEventListener('click',()=>{ selected.clear(); renderChosen(); render(); });

  submitBtn.addEventListener('click',()=>{
    const map=loadMonth(view);
    for(const d of selected){ const cur=map[d] ?? DEFAULT_SLOTS; if(cur>0) map[d]=cur-1; }
    saveMonth(view,map);
    submitMsg.textContent = "Submitted ✓ (demo)";
    selected.clear(); render(); renderChosen(); updateSelCount();
  });

  async function getRole(emailLower){
    const ref = doc(db, "roles", emailLower);
    const snap = await getDoc(ref);
    if (!snap.exists()) return "driver";
    const r = (snap.data().role||"driver").toString().toLowerCase();
    return (r==="admin"||r==="supervisor") ? r : "driver";
  }

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ window.location.href="/login"; return; }
    const email = (user.email||"").toLowerCase();
    emailEl.textContent = email;

    // Read role from Firestore
    let role = "driver";
    try { role = await getRole(email); } catch(e){ console.warn("role lookup failed", e); }

    // Show Supervisor Console button for admin/supervisor
    if (role === "admin" || role === "supervisor") { supBtn.style.display="inline-block"; }

    render(); renderChosen(); updateSelCount();
  });

  supBtn.addEventListener('click', ()=>{ window.location.href = "/supervisor"; });

  logoutBtn.addEventListener('click', async ()=>{
    try{ await signOut(auth); }catch(e){}
    try{ localStorage.clear(); sessionStorage.clear(); }catch(_){}
    window.location.href="/login";
  });
</script>
</body></html>
